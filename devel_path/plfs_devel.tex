%\documentclass[10pt,onecolumn]{IEEEtran}
\documentclass[10pt]{article}
\pagenumbering{arabic}
\pagestyle{plain}
%\pagestyle{empty}
\usepackage{fullpage}
\usepackage{setspace}
\usepackage[top=2cm,bottom=2cm,left=2cm,right=2cm]{geometry}
\usepackage{wrapfig}
\usepackage{graphicx}
\usepackage{sidecap}
\usepackage{subfig}
\usepackage{eso-pic,type1cm,color}
\usepackage{listings}
\lstset{numbers=left, numberstyle=\footnotesize, numbersep=2pt,language=Python,basicstyle=\footnotesize}

\input{macros}
\input{watermark}

\begin{document}

\title{\plfs\ Versioning Plan}
\if 0
\author{
    John Bent,
    Ryan Kroiss,
    Alfred Torrez,
    Meghan Wingate
    \\
    Los Alamos National Lab
}
\fi
\date{}
\maketitle
\thispagestyle{empty}
\pagestyle{empty}
\section{Preface}

This document attempts to lay out a design path for the planned development
versions of \plfs.  It also attempts to describe how development versions can
move into production and the various issues for transitioning between versions.
Some of the issues are technical and some are policy.  Some of the technical
issues are things like how do we implement directory management in the future
\mds.  Policy issues are questions like whether incompatible layouts are 
handled transparently by \plfs\ or whether they are handled by explicitly
copying data from an old \plfs\ into the new one.  

Our goal is to get \plfs\ into production at LANL.  However, we want to make 
sure that the production releases are bug-free, give performance attractive
to users, and are as easy to use as possible.  Hopefully by spelling out the
issues involved the current version of \plfs\ and the planned versions, we
can identify the target version for our first production release.  There is
of course a tension between releasing something soon and releasing something
good.  We could release the current version today but it has several 
limitations that will be discussed below and we need to determine whether
we are comfortable with those limitations.

At the end of this document, we will also describe current open issues
and other miscellaneous development plans.

\section{Current Version - Version 0}

The current version has support for both \fuse\ and for \adio.  However,
the \fuse\ implementation transparently maps logical paths into physical
ones.  It knows this mapping via a single mount argument naming the
physical \store.  As is true for PanFS access, each user's \plfs\ \store\ 
is located on a different PanFS volume.  This is accomplished via symbolic
links.  For example, \Path{/plfs/ben} is a symbolic link to 
\Path{/mnt/plfs/vol5/ben/.plfs\_store}.  When \plfs\ is mounted, it is mounted 
on \Path{/mnt/plfs} and directed to use \Path{/panfs/scratch} as its \store.
So a typical name resolution would work as follows:

\begin{enumerate}
\item{user ben opens logical file \Path{/plfs/ben/foo}}
\item{the sym link resolves this to logical path 
        \Path{/mnt/plfs/vol5/ben/.plfs\_store}}
\item{FUSE strips the \Path{/mnt/plfs} and \plfs\ inserts the \store\ path and resolves to physical path \Path{/panfs/scratch/vol5/ben/.plfs\_store}}
\end{enumerate}

This works great for \fuse.  The \store\ is hidden from the user.  However, for
\adio, there is no current support for mapping so when a user wants to use
\adio, they need to know and use the path to their \store.  We have observed
that users are confused by the notion of the \store\ and therefore we believe
that the \adio\ in the current version is not ready for a production release. 

We can have a production release with just \fuse, but Meghan has observed much
higher bandwidth with the \adio\ layer and believes that the bandwidth with 
just the \fuse\ layer might not be enough to convince users to switch.  
Recently, the developer of Bulk-IO has made some optimization by tuning the
IO to match the underlying stripe configuration of PanFS and although the
performance of \fuse\ is better than Bulk-IO it is not several times better
whereas the performance of \adio\ is several times better.

\section{Version 1}

Version 1 will move the mapping logic from \fuse\ into the library so it will
be shared with \adio.  However, we can no longer rely on the mount argument to
declare the \store\ as that is not seen by \adio.  We could use the mount
argument for \fuse\ and use hints for \adio\ but this exposes the \store\ to
users and we have already decided we don't want to do that.  Therefore, we have
decided that we will use an \Path{/etc/plfsrc} file on every node to declare
mappings between logical paths and {\store}s.  This file will be parsed by both
\fuse\ and \adio.

However, one problem is that we can no longer depend on symbolic links to
spread users across volumes.  We can either put all {\store}s on a single
volume or we can put a mapping entry into \plfsrc\ for every user
(\eg\ \Path{/plfs/ben} maps to \Path{/panfs/scratch/vol5/ben/.plfs\_store}).
This might be a maintenance problem however as every time a new user is
added, every \plfsrc\ file will need to be updated.  I don't know
the administrative cost of this.

\subsection{Compatibility}

Version 1 will be backwards compatible with Version 0.

\section{Version 2}

A better way to distribute users across volumes is for the \plfsrc\ to list
multiple {\store}s for each logical path.  Then \plfs\ can hash every file
and place it on a different \store.  This then becomes the \mds\ version.
We didn't intend possibly for the \mds\ version to be necessary so early
but the necessary mapping for the \adio\ layer has forced this issue earlier
than we expected.

In order to do the full \mds\ implementation, we need to decide on mechanisms
for file creation and for directory creation.  File creation is mostly
straight-forward: choose a \store\ and create the file there.  One open
questions is how to choose the \store\ for a particular file.  One approach
is to hash the filename, another is to hash the name of the node.

\section{Open issues and miscellaneous plans}

\subsection{Container identification}

Container identification is a pain in the butt.  SUID doesn't really work
and now \Path{container/accessfile} also seems not to be working.

\subsection{\adio\ optimizations}

\end{document}
